version: '3'
services:
  indexd:
    image: "quay.io/cdis/indexd"
    volumes:
      - ./apis_configs/indexd_settings.py:/var/www/indexd/local_settings.py
      - ./apis_configs/creds.json:/var/www/indexd/creds.json
      - ./apis_configs/config_helper.py:/var/www/indexd/config_helper.py
    depends_on:
      - postgres
  fence:
    image: "quay.io/cdis/fence"
    volumes:
      - ./apis_configs/fence_settings.py:/var/www/fence/local_settings.py
      - ./apis_configs/creds.json:/var/www/fence/creds.json
      - ./apis_configs/config_helper.py:/var/www/fence/config_helper.py
      - ./apis_configs/fence_credentials.json:/var/www/fence/fence_credentials.json
      - ./apis_configs/user.yaml:/var/www/fence/user.yaml
      - ./keypair.sh:/var/www/fence/keypair.sh
    command: ["bash", "/var/www/fence/keypair.sh"]
    depends_on:
      - postgres
  peregrine:
    image: "quay.io/cdis/peregrine"
    volumes:
      - ./apis_configs/peregrine_settings.py:/var/www/peregrine/wsgi.py
      - ./apis_configs/creds.json:/var/www/peregrine/creds.json
      - ./apis_configs/config_helper.py:/var/www/peregrine/config_helper.py 
    depends_on:
      - postgres
  sheepdog:
    image: "quay.io/cdis/sheepdog"
    volumes:
      - ./apis_configs/sheepdog_settings.py:/var/www/sheepdog/wsgi.py
      - ./apis_configs/creds.json:/var/www/sheepdog/creds.json
      - ./apis_configs/config_helper.py:/var/www/sheepdog/config_helper.py 
    depends_on:
      - postgres
  dataportal:
    image: "quay.io/cdis/data-portal"
    # image: "quay.io/cdis/data-portal:fix_getSchema-listen-loop"
    volumes:
      - ./waitForContainers.sh:/var/www/data-portal/waitForContainers.sh
    # command: ["echo", "hello there"]
    command: ["bash", "/var/www/data-portal/waitForContainers.sh"]
    environment:
      - NODE_ENV=dev
      - MOCK_STORE=true
      - APP=dev
      - GDC_SUBPATH=http://nginx/api/v0/submission/
    depends_on:
      - postgres
      - peregrine
      - sheepdog
  nginx:
    image: "nginx"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - "80:80"
    restart: on-failure
    depends_on:
      - indexd
      - peregrine
      - sheepdog
      - fence
      - dataportal
  postgres:
    image: postgres:9.5
    volumes:
      - "psqldata:/var/lib/postgresql/data"
      # - "/home:/mnt/Users"
    # ports:
    #   - 5432:5432
    restart: unless-stopped
    
volumes:
  psqldata: